// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserType {
  CLIENT
  BARBER
  ADMIN
}

enum BookingStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum PaymentStatus {
  PENDING
  PAID
  REFUNDED
  FAILED
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  phone     String?
  firstName String
  lastName  String
  avatar    String?
  userType  UserType
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Client specific
  preferredStyles String[]
  loyaltyPoints   Int      @default(0)

  // Barber specific
  barberProfile BarberProfile?
  
  // Relations
  bookingsAsClient  Booking[] @relation("ClientBookings")
  bookingsAsBarber  Booking[] @relation("BarberBookings")
  reviewsGiven      Review[]  @relation("ReviewsGiven")
  reviewsReceived   Review[]  @relation("ReviewsReceived")
  payments          Payment[]
  notifications     Notification[]
  favoriteBarbers   FavoriteBarber[]

  @@map("users")
}

model BarberProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  shopName        String
  bio             String?
  yearsExperience Int
  address         String
  city            String
  state           String
  zipCode         String
  latitude        Float?
  longitude       Float?
  
  // Business info
  businessHours   Json // Store as JSON: { monday: { open: "09:00", close: "18:00" }, ... }
  isOpen          Boolean  @default(true)
  acceptsWalkIns  Boolean  @default(false)
  
  // Social links
  instagram       String?
  website         String?
  
  // Ratings
  averageRating   Float    @default(0.0)
  totalReviews    Int      @default(0)
  totalClients    Int      @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  services        Service[]
  portfolioItems  PortfolioItem[]
  specialties     BarberSpecialty[]
  bookings        Booking[] @relation("BarberBookings")
  reviews         Review[]
  reels           Reel[]
  favoriteBarbers FavoriteBarber[]

  @@map("barber_profiles")
}

model Specialty {
  id          String            @id @default(cuid())
  name        String            @unique
  description String?
  createdAt   DateTime          @default(now())
  
  barbers     BarberSpecialty[]
  services    Service[]
  
  @@map("specialties")
}

model BarberSpecialty {
  id          String        @id @default(cuid())
  barberId    String
  barber      BarberProfile @relation(fields: [barberId], references: [id], onDelete: Cascade)
  specialtyId String
  specialty   Specialty     @relation(fields: [specialtyId], references: [id], onDelete: Cascade)
  
  @@unique([barberId, specialtyId])
  @@map("barber_specialties")
}

model Service {
  id          String        @id @default(cuid())
  barberId    String
  barber      BarberProfile @relation(fields: [barberId], references: [id], onDelete: Cascade)
  specialtyId String?
  specialty   Specialty?    @relation(fields: [specialtyId], references: [id])
  
  name        String
  description String?
  price       Float
  duration    Int           // in minutes
  isPopular   Boolean       @default(false)
  isActive    Boolean       @default(true)
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  // Relations
  bookings    BookingService[]
  
  @@map("services")
}

model Booking {
  id            String        @id @default(cuid())
  clientId      String
  client        User          @relation("ClientBookings", fields: [clientId], references: [id])
  barberId      String
  barber        User          @relation("BarberBookings", fields: [barberId], references: [id])
  barberProfile BarberProfile @relation("BarberBookings", fields: [barberId], references: [userId])
  
  appointmentDate DateTime
  startTime       DateTime
  endTime         DateTime
  status          BookingStatus @default(PENDING)
  
  totalPrice      Float
  notes           String?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  services        BookingService[]
  payment         Payment?
  review          Review?
  
  @@map("bookings")
}

model BookingService {
  id        String  @id @default(cuid())
  bookingId String
  booking   Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  serviceId String
  service   Service @relation(fields: [serviceId], references: [id])
  
  price     Float   // Price at time of booking
  duration  Int     // Duration at time of booking
  
  @@unique([bookingId, serviceId])
  @@map("booking_services")
}

model Payment {
  id              String        @id @default(cuid())
  userId          String
  user            User          @relation(fields: [userId], references: [id])
  bookingId       String?       @unique
  booking         Booking?      @relation(fields: [bookingId], references: [id])
  
  amount          Float
  currency        String        @default("USD")
  status          PaymentStatus @default(PENDING)
  paymentMethod   String        // "card", "paypal", "apple_pay", etc.
  
  // Stripe fields
  stripePaymentId String?       @unique
  stripeSessionId String?       @unique
  
  // Prepay/Wallet
  isWalletPayment Boolean       @default(false)
  loyaltyPointsUsed Int         @default(0)
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@map("payments")
}

model Review {
  id        String   @id @default(cuid())
  bookingId String   @unique
  booking   Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  clientId  String
  client    User     @relation("ReviewsGiven", fields: [clientId], references: [id])
  barberId  String
  barber    User     @relation("ReviewsReceived", fields: [barberId], references: [id])
  barberProfile BarberProfile @relation(fields: [barberId], references: [userId])
  
  rating    Int      // 1-5 stars
  comment   String?
  isVerified Boolean @default(true) // Since it's tied to a booking
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("reviews")
}

model PortfolioItem {
  id        String        @id @default(cuid())
  barberId  String
  barber    BarberProfile @relation(fields: [barberId], references: [id], onDelete: Cascade)
  
  type      String        // "image", "video"
  url       String
  thumbnail String?       // For videos
  caption   String?
  tags      String[]      // Style tags
  
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  
  @@map("portfolio_items")
}

model Reel {
  id          String        @id @default(cuid())
  barberId    String
  barber      BarberProfile @relation(fields: [barberId], references: [id], onDelete: Cascade)
  
  videoUrl    String
  thumbnail   String
  title       String
  description String?
  tags        String[]
  
  likes       Int           @default(0)
  views       Int           @default(0)
  shares      Int           @default(0)
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  // Relations
  likes_users ReelLike[]
  
  @@map("reels")
}

model ReelLike {
  id     String @id @default(cuid())
  reelId String
  reel   Reel   @relation(fields: [reelId], references: [id], onDelete: Cascade)
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@unique([reelId, userId])
  @@map("reel_likes")
}

model FavoriteBarber {
  id       String        @id @default(cuid())
  userId   String
  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  barberId String
  barber   BarberProfile @relation(fields: [barberId], references: [id], onDelete: Cascade)
  
  createdAt DateTime     @default(now())
  
  @@unique([userId, barberId])
  @@map("favorite_barbers")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type      String   // "booking_confirmed", "payment_received", "review_received", etc.
  title     String
  message   String
  data      Json?    // Additional data as JSON
  
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  
  @@map("notifications")
}
